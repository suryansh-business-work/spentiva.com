# =============================================================================
# Spentiva Deploy ALL Services
# Manually trigger to deploy all services
# =============================================================================

name: ğŸŒ Deploy Spentiva ALL Services

on:
  workflow_dispatch:

jobs:
  deploy-all:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¢ Slack - Full Deployment Started
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "attachments": [{"color": "#6B5CE7", "blocks": [
              {"type": "header", "text": {"type": "plain_text", "text": "ğŸŒ SPENTIVA - Full Platform Deployment", "emoji": true}},
              {"type": "section", "text": {"type": "mrkdwn", "text": "*Deploying all 3 services...*"}},
              {"type": "section", "fields": [
                {"type": "mrkdwn", "text": "ğŸŒ Website (5000)"},
                {"type": "mrkdwn", "text": "ğŸ“± App UI (5001)"},
                {"type": "mrkdwn", "text": "âš™ï¸ App Server (5002)"}
              ]},
              {"type": "context", "elements": [{"type": "mrkdwn", "text": "ğŸ‘¤ ${{ github.actor }} | ğŸ·ï¸ Build #${{ github.run_number }}"}]}
            ]}]
          }' ${{ secrets.SLACK_WEBHOOK }}

      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ========== BUILD ALL ==========
      - name: ğŸ—ï¸ Build Website
        uses: docker/build-push-action@v5
        with:
          context: ./website
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/spentiva-website:latest

      - name: ğŸ—ï¸ Build App UI
        uses: docker/build-push-action@v5
        with:
          context: ./app/ui
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/spentiva-app-ui:latest
          build-args: VITE_API_BASE_URL=https://server.spentiva.com/api

      - name: ğŸ—ï¸ Build App Server
        uses: docker/build-push-action@v5
        with:
          context: ./app/server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/spentiva-app-server:latest

      # ========== DEPLOY ALL ==========
      - name: ğŸš€ Deploy All to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            echo "ğŸ”§ Creating network..."
            docker network create spentiva-network 2>/dev/null || true

            echo "ğŸ“¦ Pulling all images..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/spentiva-website:latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/spentiva-app-ui:latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/spentiva-app-server:latest

            echo "ğŸ›‘ Stopping all containers..."
            docker stop spentiva-website spentiva-app-ui spentiva-app-server 2>/dev/null || true
            docker rm -f spentiva-website spentiva-app-ui spentiva-app-server 2>/dev/null || true

            echo "ğŸš€ Starting Website (5000)..."
            docker run -d \
              --name spentiva-website \
              --restart unless-stopped \
              --network spentiva-network \
              -p 5000:5000 \
              -e NODE_ENV=production \
              -e PORT=5000 \
              ${{ secrets.DOCKERHUB_USERNAME }}/spentiva-website:latest

            echo "ğŸš€ Starting App UI (5001)..."
            docker run -d \
              --name spentiva-app-ui \
              --restart unless-stopped \
              --network spentiva-network \
              -p 5001:80 \
              -e NODE_ENV=production \
              ${{ secrets.DOCKERHUB_USERNAME }}/spentiva-app-ui:latest

            echo "ğŸš€ Starting App Server (5002)..."
            cat > /tmp/server.env << 'ENVEOF'
            NODE_ENV=production
            PORT=5002
            DBURL=${{ secrets.DBURL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
            APP_URL=${{ secrets.APP_URL }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            NODEMAILER_HOST=${{ secrets.NODEMAILER_HOST }}
            NODEMAILER_PORT=${{ secrets.NODEMAILER_PORT }}
            NODEMAILER_USER=${{ secrets.NODEMAILER_USER }}
            NODEMAILER_PASS=${{ secrets.NODEMAILER_PASS }}
            IMAGEKIT_PUBLIC_KEY=${{ secrets.IMAGEKIT_PUBLIC_KEY }}
            IMAGEKIT_PRIVATE_KEY=${{ secrets.IMAGEKIT_PRIVATE_KEY }}
            IMAGEKIT_URL_ENDPOINT=${{ secrets.IMAGEKIT_URL_ENDPOINT }}
            AUTH_SERVICE_URL=${{ secrets.AUTH_SERVICE_URL }}
            AUTH_SECRET=${{ secrets.AUTH_SECRET }}
            LOG_LEVEL=${{ secrets.LOG_LEVEL }}
            ENVEOF
            
            docker run -d \
              --name spentiva-app-server \
              --restart unless-stopped \
              --network spentiva-network \
              -p 5002:5002 \
              --env-file /tmp/server.env \
              ${{ secrets.DOCKERHUB_USERNAME }}/spentiva-app-server:latest
            
            rm -f /tmp/server.env

            echo "â³ Waiting for services..."
            sleep 10

            echo "ğŸ“Š All Containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: âœ… Slack - All Deployed
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "attachments": [{"color": "#00C853", "blocks": [
              {"type": "header", "text": {"type": "plain_text", "text": "ğŸ‰ SPENTIVA - ALL Services Deployed!", "emoji": true}},
              {"type": "section", "fields": [
                {"type": "mrkdwn", "text": "âœ… Website:5000"},
                {"type": "mrkdwn", "text": "âœ… App UI:5001"},
                {"type": "mrkdwn", "text": "âœ… App Server:5002"}
              ]},
              {"type": "actions", "elements": [
                {"type": "button", "text": {"type": "plain_text", "text": "ğŸŒ Website"}, "url": "https://spentiva.com", "style": "primary"},
                {"type": "button", "text": {"type": "plain_text", "text": "ğŸ“± App"}, "url": "https://app.spentiva.com"}
              ]}
            ]}]
          }' ${{ secrets.SLACK_WEBHOOK }}

      - name: âŒ Slack - Failed
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "attachments": [{"color": "#FF1744", "blocks": [
              {"type": "header", "text": {"type": "plain_text", "text": "âŒ SPENTIVA - Deployment FAILED!", "emoji": true}},
              {"type": "actions", "elements": [
                {"type": "button", "text": {"type": "plain_text", "text": "ğŸ“‹ Logs"}, "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "style": "danger"}
              ]}
            ]}]
          }' ${{ secrets.SLACK_WEBHOOK }}
